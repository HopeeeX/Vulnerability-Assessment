"use client";
import React, { useState } from "react";
import Link from "next/link";
import QrModal from "../../components/Modals/QrModal";
import toast from "react-hot-toast";
import { useAppSelector, useAppDispatch } from "@/lib/hooks";
import { updateUser } from "@/lib/userSlice";

const page = () => {
    const [showModal, setShowModal] = useState(false);
    const dispatch = useAppDispatch()
    const user = useAppSelector((state) => state.user.access_token)
    const qr_url = useAppSelector((state) => state.user.two_fa_qr_url)

    const handleOpenModal = () => {
        setShowModal(true);
    };
    async function handleSubmit(event) {
        event.preventDefault();
        const formData = new FormData(event.currentTarget);
        const response = await fetch("/api/sign-in/", {
            method: "POST",
            body: JSON.stringify({
                email: formData.get("email"),
                password: formData.get("password"),
            }),
        });
        const data = await response.json();
        if (response.status == 200) {
            //store redux
            const qr_url = data.two_fa_qr_url;
            const access_token = data.access_token;
            await dispatch(updateUser({access_token: access_token, qr_url: qr_url}));
            handleOpenModal();
        } else {
        toast.error(data.message)
        }
    }

    console.log(user)

    return (
        <div className="bg-[#F5F9FA] h-screen flex flex-col justify-center items-center px-[20px]">
            <form method="post" onSubmit={handleSubmit}>
                <div className="flex flex-col justify-center items-center bg-white p-[30px] rounded-md shadow-md">
                    {/*Title & Description*/}
                    <div className="flex flex-col justify-center items-center">
                        <h1 className="text-[#52617B] font-bold text-[20px]">
                            Sign In
                        </h1>
                        <h2 className="text-[#C3C8CE] font-medium text-[13px]">
                            Fill up the following information below.
                        </h2>
                    </div>
                    {/*Input Fields*/}
                    <div className="flex flex-col justify-center items-center">
                        {/*Email*/}
                        <div>
                            <div className="mt-[20px]">
                                <label className="text-black text-opacity-55 font-semibold text-[13px]">
                                    Email
                                </label>
                            </div>
                            <div className=" w-full">
                                <input
                                    className="w-[250px] px-[10px] py-[7px] outline-none rounded-md border border-black border-opacity-30 text-[12px] text-black text-opacity-65"
                                    type="text"
                                    name="email"
                                    placeholder="Enter email"
                                />
                            </div>
                        </div>
                        {/*Password*/}
                        <div>
                            <div className="mt-[10px]">
                                <label className="text-black text-opacity-55 font-semibold text-[13px]">
                                    Password
                                </label>
                            </div>
                            <div className=" w-full">
                                <input
                                    className="w-[250px] px-[10px] py-[7px] outline-none rounded-md border border-black border-opacity-30 text-[12px] text-black text-opacity-65"
                                    type="text"
                                    name="password"
                                    placeholder="Enter password"
                                />
                            </div>
                        </div>
                        {/*Sign In Button*/}
                        <div className="mt-[15px]">
                            <button
                                type="submit"
                                className="w-[250px] bg-[#344564] hover:bg-[#222d42] text-center text-white text-[13px] font-bold py-[7px] rounded-md"
                            >
                                Sign In
                            </button>
                            {showModal && <QrModal qr_url={qr_url} />}
                        </div>
                        {/*Sign Up Link*/}
                        <div className="flex justify-center mt-[20px] gap-1">
                            <span className="text-[12px] text-black text-opacity-50">
                                Don't have an account yet?
                            </span>
                            <Link
                                href={"/"}
                                className="text-[12px] text-black text-opacity-50 hover:text-gray-600"
                            >
                                Sign Up
                            </Link>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    );
};

export default page;
